<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NASCAR Fantasy League</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin
    src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ==================== CONFIGURATION ====================
    // IMPORTANT: Replace with your Google Apps Script Web App URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbw1w6CuHehwbnLKqB8tYh1dc8NUVrCoMAG-jzLhRadyyXmyYHvh-wuT4gZ4zQOp18rf/exec';
    const PASSCODE = 'spider2ybanana!'; // Must match the passcode in Code.gs

    // Constants
    const TRACK_TYPES = ['Superspeedway', 'Intermediate', 'Short Track', 'Road Course'];

    const DEFAULT_2026_SCHEDULE = [
      { id: 1, name: 'Daytona 500', date: '2026-02-16', time: '2:30 PM ET', track: 'Daytona', type: 'Superspeedway' },
      { id: 2, name: 'Atlanta', date: '2026-02-23', time: '3:00 PM ET', track: 'Atlanta', type: 'Intermediate' },
      { id: 3, name: 'Las Vegas', date: '2026-03-02', time: '3:30 PM ET', track: 'Las Vegas', type: 'Intermediate' },
      { id: 4, name: 'Phoenix', date: '2026-03-09', time: '3:30 PM ET', track: 'Phoenix', type: 'Short Track' },
      { id: 5, name: 'Bristol', date: '2026-03-16', time: '7:00 PM ET', track: 'Bristol', type: 'Short Track' },
      { id: 6, name: 'COTA', date: '2026-03-23', time: '3:30 PM ET', track: 'COTA', type: 'Road Course' },
      { id: 7, name: 'Richmond', date: '2026-03-30', time: '7:00 PM ET', track: 'Richmond', type: 'Short Track' },
      { id: 8, name: 'Martinsville', date: '2026-04-06', time: '7:00 PM ET', track: 'Martinsville', type: 'Short Track' },
      { id: 9, name: 'Texas', date: '2026-04-13', time: '3:30 PM ET', track: 'Texas', type: 'Intermediate' },
      { id: 10, name: 'Talladega', date: '2026-04-27', time: '3:00 PM ET', track: 'Talladega', type: 'Superspeedway' }
    ];

    // Consolidated Icons
    const Icons = {
      Calendar: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      ),
      Trophy: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
          <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
          <path d="M4 22h16"></path>
          <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
          <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
          <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
        </svg>
      ),
      TrendingUp: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
      ),
      Users: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
      ),
      Plus: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      ),
      Upload: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
      ),
      Save: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
      ),
      X: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      ),
      ChevronDown: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      ),
      ChevronUp: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
      ),
      Lock: ({ size = 24 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      )
    };

    // ==================== API CLIENT ====================

    const api = {
      async callGet(action) {
        try {
          const url = `${API_URL}?action=${action}&passcode=${encodeURIComponent(PASSCODE)}`;
          const response = await fetch(url);
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          return data;
        } catch (error) {
          console.error('API GET Error:', error);
          throw error;
        }
      },

      async callPost(action, payload = {}) {
        try {
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, passcode: PASSCODE, ...payload })
          });

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          return data;
        } catch (error) {
          console.error('API POST Error:', error);
          throw error;
        }
      }
    };

    // Utility Functions
    const getStatusClassName = (status) => {
      if (status.startsWith('Error')) return 'bg-red-100 text-red-800';
      if (status.startsWith('Success')) return 'bg-green-100 text-green-800';
      return 'bg-blue-100 text-blue-800';
    };

    const processCSV = async (file, requiredColumns, processor) => {
      const text = await file.text();
      const lines = text.split('\n').filter(line => line.trim());

      if (lines.length < 2) {
        throw new Error('CSV file appears empty');
      }

      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

      // Validate required columns
      for (const col of requiredColumns) {
        if (!headers.includes(col)) {
          throw new Error(`CSV must have "${col}" column`);
        }
      }

      return processor(lines, headers);
    };

    // ==================== LOGIN COMPONENT ====================

    const LoginScreen = ({ onLogin }) => {
      const [inputPasscode, setInputPasscode] = useState('');
      const [error, setError] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (inputPasscode === PASSCODE) {
          onLogin();
        } else {
          setError('Invalid passcode');
          setInputPasscode('');
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-700 to-blue-900 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div className="flex justify-center mb-6">
              <Icons.Lock size={48} className="text-blue-600" />
            </div>
            <h1 className="text-3xl font-bold text-center mb-2">NASCAR Fantasy League</h1>
            <p className="text-gray-600 text-center mb-6">Enter passcode to continue</p>

            <form onSubmit={handleSubmit}>
              <input
                type="password"
                value={inputPasscode}
                onChange={(e) => { setInputPasscode(e.target.value); setError(''); }}
                placeholder="Enter passcode"
                className="w-full border-2 rounded px-4 py-3 mb-4 text-lg focus:outline-none focus:border-blue-600"
                autoFocus
              />

              {error && (
                <div className="bg-red-100 text-red-800 p-3 rounded mb-4">
                  {error}
                </div>
              )}

              <button
                type="submit"
                className="w-full bg-blue-600 text-white py-3 rounded font-semibold hover:bg-blue-700 transition-colors"
              >
                Sign In
              </button>
            </form>

            <p className="text-sm text-gray-500 text-center mt-6">
              Powered by Google Apps Script
            </p>
          </div>
        </div>
      );
    };

    // ==================== MAIN APP COMPONENT ====================

    const NASCARFantasyApp = () => {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [activeTab, setActiveTab] = useState('schedule');
      const [users, setUsers] = useState([]);
      const [activDrivers, setActiveDrivers] = useState([]);
      const [races, setRaces] = useState([]);
      const [picks, setPicks] = useState({});
      const [raceResults, setRaceResults] = useState({});
      const [bonusPoints, setBonusPoints] = useState({});
      const [historicalData, setHistoricalData] = useState([]);
      const [selectedRace, setSelectedRace] = useState(null);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [connectionStatus, setConnectionStatus] = useState('connected');

      // Load data from backend on mount
      useEffect(() => {
        if (isAuthenticated) {
          loadData();
        }
      }, [isAuthenticated]);

      const loadData = async () => {
        try {
          setLoading(true);
          setConnectionStatus('loading');
          const data = await api.callGet('getAllData');

          setUsers(data.users || []);
          setActiveDrivers(data.activeDrivers || []);
          setRaces(data.races || []);
          setPicks(data.picks || {});
          setRaceResults(data.raceResults || {});
          setBonusPoints(data.bonusPoints || {});
          setHistoricalData(data.historicalData || []);
          setConnectionStatus('connected');
        } catch (err) {
          console.error('Error loading data:', err);
          setConnectionStatus('error');
          alert('Failed to load data from server: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const saveData = async () => {
        try {
          setSaving(true);
          await api.callPost('saveAll', {
            races,
            picks,
            raceResults,
            bonusPoints,
            historicalData
          });
          alert('Data saved successfully!');
        } catch (err) {
          console.error('Error saving data:', err);
          alert('Error saving data: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      // Initialize with default schedule if empty
      useEffect(() => {
        if (races.length === 0 && !loading && isAuthenticated) {
          setRaces(DEFAULT_2026_SCHEDULE);
        }
      }, [loading, isAuthenticated]);

      if (!isAuthenticated) {
        return <LoginScreen onLogin={() => setIsAuthenticated(true)} />;
      }

      if (loading) {
        return (
          <div className="flex flex-col items-center justify-center h-screen bg-gray-100">
            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-4"></div>
            <p className="text-gray-600">Loading league data...</p>
          </div>
        );
      }

      const SchedulePage = () => (
        <div className="space-y-4">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold">2026 Race Schedule</h2>
            <button
              onClick={saveData}
              disabled={saving}
              className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
            >
              <Icons.Save size={18} />
              {saving ? 'Saving...' : 'Save All Data'}
            </button>
          </div>

          <div className="grid gap-4">
            {races.map(race => (
              <div key={race.id} className="bg-white border rounded-lg p-4 hover:shadow-lg transition-shadow">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <h3 className="text-xl font-semibold">{race.name}</h3>
                    <p className="text-gray-600">{new Date(race.date).toLocaleDateString()}{race.time && ` • ${race.time}`}</p>
                    <p className="text-sm text-gray-500">{race.track} • {race.type}</p>
                  </div>
                  <button
                    onClick={() => { setSelectedRace(race); setActiveTab('race-detail'); }}
                    className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                  >
                    Manage Race
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );

      const RaceDetailPage = () => {
        if (!selectedRace) return <div>Select a race from the schedule</div>;

        const [userPicks, setUserPicks] = useState({});
        const [driverScores, setDriverScores] = useState({});
        const [userBonuses, setUserBonuses] = useState({});

        useEffect(() => {
          const raceKey = `race_${selectedRace.id}`;
          setUserPicks(picks[raceKey] || {});
          setDriverScores(raceResults[raceKey] || {});
          setUserBonuses(bonusPoints[raceKey] || {});
        }, [selectedRace]);

        const updatePicks = (userId, driverIndex, driverName) => {
          const raceKey = `race_${selectedRace.id}`;
          const newPicks = { ...picks };
          if (!newPicks[raceKey]) newPicks[raceKey] = {};
          if (!newPicks[raceKey][userId]) newPicks[raceKey][userId] = ['', '', ''];

          newPicks[raceKey][userId][driverIndex] = driverName;
          setPicks(newPicks);
          setUserPicks(newPicks[raceKey]);
        };

        const updateDriverScore = (driverName, points) => {
          const raceKey = `race_${selectedRace.id}`;
          const newResults = { ...raceResults };
          if (!newResults[raceKey]) newResults[raceKey] = {};
          newResults[raceKey][driverName] = parseFloat(points) || 0;
          setRaceResults(newResults);
          setDriverScores(newResults[raceKey]);
        };

        const updateBonus = (userId, points) => {
          const raceKey = `race_${selectedRace.id}`;
          const newBonuses = { ...bonusPoints };
          if (!newBonuses[raceKey]) newBonuses[raceKey] = {};
          newBonuses[raceKey][userId] = parseFloat(points) || 0;
          setBonusPoints(newBonuses);
          setUserBonuses(newBonuses[raceKey]);
        };

        const getPrevRaceDrivers = (userId) => {
          const prevRaceId = selectedRace.id - 1;
          if (prevRaceId < 1) return [];
          const prevKey = `race_${prevRaceId}`;
          return picks[prevKey]?.[userId] || [];
        };

        return (
          <div className="space-y-6">
            <div className="flex items-center gap-4">
              <button onClick={() => setActiveTab('schedule')} className="text-blue-600 hover:underline">
                ← Back to Schedule
              </button>
              <h2 className="text-2xl font-bold">{selectedRace.name}</h2>
            </div>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">User Picks</h3>
              {users.map(user => (
                <div key={user} className="mb-6 p-4 bg-gray-50 rounded">
                  <h4 className="font-semibold mb-3">{user}</h4>
                  <div className="grid grid-cols-3 gap-4">
                    {[0, 1, 2].map(i => (
                      <div key={i}>
                        <label className="block text-sm font-medium mb-1">Driver {i + 1}</label>
                        <select
                          value={userPicks[user]?.[i] || ''}
                          onChange={(e) => updatePicks(user, i, e.target.value)}
                          className="w-full border rounded px-3 py-2"
                        >
                          <option value="">Select driver</option>
                          {activDrivers
                            .filter(d => !getPrevRaceDrivers(user).includes(d))
                            .map(driver => (
                              <option key={driver} value={driver}>{driver}</option>
                            ))}
                        </select>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">Driver Race Results</h3>
              <div className="grid grid-cols-2 gap-4">
                {activDrivers.map(driver => (
                  <div key={driver} className="flex items-center gap-2">
                    <label className="flex-1">{driver}</label>
                    <input
                      type="number"
                      placeholder="Points"
                      value={driverScores[driver] || ''}
                      onChange={(e) => updateDriverScore(driver, e.target.value)}
                      className="w-24 border rounded px-3 py-2"
                    />
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">Bonus Points</h3>
              <div className="grid grid-cols-2 gap-4">
                {users.map(user => (
                  <div key={user} className="flex items-center gap-2">
                    <label className="flex-1">{user}</label>
                    <input
                      type="number"
                      placeholder="Bonus"
                      value={userBonuses[user] || ''}
                      onChange={(e) => updateBonus(user, e.target.value)}
                      className="w-24 border rounded px-3 py-2"
                    />
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      };

      const LeaderboardPage = () => {
        const calculateStandings = () => {
          const standings = {};

          users.forEach(user => {
            let totalPoints = 0;
            races.forEach(race => {
              const raceKey = `race_${race.id}`;
              const userPicksForRace = picks[raceKey]?.[user] || [];
              const resultsForRace = raceResults[raceKey] || {};
              const bonusForRace = bonusPoints[raceKey]?.[user] || 0;

              const racePoints = userPicksForRace.reduce((sum, driver) =>
                sum + (resultsForRace[driver] || 0), 0);

              totalPoints += racePoints + bonusForRace;
            });

            standings[user] = totalPoints;
          });

          return Object.entries(standings)
            .sort((a, b) => b[1] - a[1])
            .map(([user, points], index) => ({ user, points, position: index + 1 }));
        };

        const standings = calculateStandings();

        return (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold">Season Leaderboard</h2>

            <div className="bg-white rounded-lg border overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="px-6 py-3 text-left">Position</th>
                    <th className="px-6 py-3 text-left">User</th>
                    <th className="px-6 py-3 text-right">Total Points</th>
                  </tr>
                </thead>
                <tbody>
                  {standings.map((s, i) => (
                    <tr key={s.user} className={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      <td className="px-6 py-4 font-bold text-lg">{s.position}</td>
                      <td className="px-6 py-4 font-semibold">{s.user}</td>
                      <td className="px-6 py-4 text-right font-semibold">{s.points.toFixed(1)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      const InsightsPage = () => {
        const getTrackTypePerformance = () => {
          const userPerf = {};
          const driverPerf = {};

          users.forEach(user => { userPerf[user] = {}; });
          activDrivers.forEach(driver => { driverPerf[driver] = {}; });

          races.forEach(race => {
            const raceKey = `race_${race.id}`;
            const resultsForRace = raceResults[raceKey] || {};

            users.forEach(user => {
              const userPicksForRace = picks[raceKey]?.[user] || [];
              const points = userPicksForRace.reduce((sum, driver) =>
                sum + (resultsForRace[driver] || 0), 0);

              if (!userPerf[user][race.type]) userPerf[user][race.type] = { points: 0, races: 0 };
              userPerf[user][race.type].points += points;
              userPerf[user][race.type].races += 1;
            });

            activDrivers.forEach(driver => {
              const points = resultsForRace[driver] || 0;
              if (points > 0) {
                if (!driverPerf[driver][race.type]) driverPerf[driver][race.type] = { points: 0, races: 0 };
                driverPerf[driver][race.type].points += points;
                driverPerf[driver][race.type].races += 1;
              }
            });
          });

          return { userPerf, driverPerf };
        };

        const getHistoricalDriverPerformance = () => {
          const perfByTrack = {};
          const perfByTrackType = {};

          historicalData.forEach(record => {
            // By specific track
            if (!perfByTrack[record.driver]) perfByTrack[record.driver] = {};
            if (!perfByTrack[record.driver][record.track]) {
              perfByTrack[record.driver][record.track] = { points: 0, races: 0 };
            }
            perfByTrack[record.driver][record.track].points += record.points;
            perfByTrack[record.driver][record.track].races += 1;

            // By track type
            if (!perfByTrackType[record.driver]) perfByTrackType[record.driver] = {};
            if (!perfByTrackType[record.driver][record.trackType]) {
              perfByTrackType[record.driver][record.trackType] = { points: 0, races: 0 };
            }
            perfByTrackType[record.driver][record.trackType].points += record.points;
            perfByTrackType[record.driver][record.trackType].races += 1;
          });

          return { perfByTrack, perfByTrackType };
        };

        const { userPerf, driverPerf } = getTrackTypePerformance();
        const { perfByTrack, perfByTrackType } = getHistoricalDriverPerformance();
        const [showHistorical, setShowHistorical] = useState(false);
        const [selectedDriver, setSelectedDriver] = useState(null);

        return (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold">Advanced Insights</h2>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">User Performance by Track Type</h3>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="px-4 py-2 text-left">User</th>
                      {TRACK_TYPES.map(type => (
                        <th key={type} className="px-4 py-2 text-right">{type}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {users.map((user, i) => (
                      <tr key={user} className={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-4 py-2 font-semibold">{user}</td>
                        {TRACK_TYPES.map(type => {
                          const data = userPerf[user][type];
                          const avg = data ? (data.points / data.races).toFixed(1) : '0.0';
                          return <td key={type} className="px-4 py-2 text-right">{avg}</td>;
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">Driver Performance by Track Type (2026)</h3>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="px-4 py-2 text-left">Driver</th>
                      {TRACK_TYPES.map(type => (
                        <th key={type} className="px-4 py-2 text-right">{type}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {activDrivers.map((driver, i) => (
                      <tr key={driver} className={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="px-4 py-2 font-semibold">{driver}</td>
                        {TRACK_TYPES.map(type => {
                          const data = driverPerf[driver][type];
                          const avg = data ? (data.points / data.races).toFixed(1) : '0.0';
                          return <td key={type} className="px-4 py-2 text-right">{avg}</td>;
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {historicalData.length > 0 && (
              <div className="bg-white rounded-lg p-6 border">
                <h3 className="text-xl font-semibold mb-4">Driver Performance by Track Type (Historical)</h3>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-4 py-2 text-left">Driver</th>
                        {TRACK_TYPES.map(type => (
                          <th key={type} className="px-4 py-2 text-right">{type}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {activDrivers.map((driver, i) => {
                        const hasData = perfByTrackType[driver];
                        if (!hasData) return null;
                        return (
                          <tr key={driver} className={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="px-4 py-2 font-semibold">{driver}</td>
                            {TRACK_TYPES.map(type => {
                              const typeData = perfByTrackType[driver]?.[type];
                              if (!typeData) {
                                return <td key={type} className="px-4 py-2 text-right text-gray-400">-</td>;
                              }
                              
                              // Calculate average
                              const avg = (typeData.points / typeData.races).toFixed(1);
                              
                              // Calculate median - get all points for this driver/track type
                              const allPoints = historicalData
                                .filter(r => r.driver === driver && r.trackType === type)
                                .map(r => r.points)
                                .sort((a, b) => a - b);
                              
                              let median = 0;
                              if (allPoints.length > 0) {
                                const mid = Math.floor(allPoints.length / 2);
                                median = allPoints.length % 2 === 0
                                  ? ((allPoints[mid - 1] + allPoints[mid]) / 2)
                                  : allPoints[mid];
                              }
                              
                              return (
                                <td key={type} className="px-4 py-2 text-right">
                                  {avg} <span className="text-xs text-gray-500">({median.toFixed(1)})</span>
                                </td>
                              );
                            })}
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {historicalData.length > 0 && (
              <>
                <div className="bg-white rounded-lg p-6 border">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-semibold">Historical Driver Performance</h3>
                    <button
                      onClick={() => setShowHistorical(!showHistorical)}
                      className="flex items-center gap-2 text-blue-600 hover:text-blue-800"
                    >
                      {showHistorical ? <Icons.ChevronUp size={20} /> : <Icons.ChevronDown size={20} />}
                      {showHistorical ? 'Hide' : 'Show'} Historical Data
                    </button>
                  </div>

                  {showHistorical && (
                    <div className="space-y-4">
                      <div>
                        <label className="block font-medium mb-2">Select Driver for Details:</label>
                        <select
                          value={selectedDriver || ''}
                          onChange={(e) => setSelectedDriver(e.target.value)}
                          className="border rounded px-3 py-2 w-64"
                        >
                          <option value="">Choose a driver...</option>
                          {activDrivers.map(driver => (
                            <option key={driver} value={driver}>{driver}</option>
                          ))}
                        </select>
                      </div>

                      {selectedDriver && perfByTrackType[selectedDriver] && (
                        <div>
                          <h4 className="font-semibold mb-2">Historical Avg by Track Type - {selectedDriver}</h4>
                          <div className="grid grid-cols-4 gap-4">
                            {TRACK_TYPES.map(type => {
                              const data = perfByTrackType[selectedDriver][type];
                              const avg = data ? (data.points / data.races).toFixed(1) : 'N/A';
                              const races = data ? data.races : 0;
                              return (
                                <div key={type} className="bg-gray-50 p-3 rounded">
                                  <div className="text-sm text-gray-600">{type}</div>
                                  <div className="text-2xl font-bold">{avg}</div>
                                  <div className="text-xs text-gray-500">{races} races</div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {selectedDriver && perfByTrack[selectedDriver] && (
                        <div>
                          <h4 className="font-semibold mb-2">Historical Avg by Track - {selectedDriver}</h4>
                          <div className="grid grid-cols-3 gap-3">
                            {Object.entries(perfByTrack[selectedDriver])
                              .sort((a, b) => b[1].points / b[1].races - a[1].points / a[1].races)
                              .map(([track, data]) => (
                                <div key={track} className="bg-gray-50 p-3 rounded">
                                  <div className="font-medium">{track}</div>
                                  <div className="text-lg font-bold">{(data.points / data.races).toFixed(1)}</div>
                                  <div className="text-xs text-gray-500">{data.races} races</div>
                                </div>
                              ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </>
            )}
          </div>
        );
      };

      const SetupPage = () => {
        const [newUser, setNewUser] = useState('');
        const [newDriver, setNewDriver] = useState('');
        const [uploadStatus, setUploadStatus] = useState('');
        const [scheduleUploadStatus, setScheduleUploadStatus] = useState('');

        const addUser = async () => {
          if (!newUser || users.includes(newUser)) return;

          try {
            await api.callPost('addUser', { userName: newUser });
            setUsers([...users, newUser]);
            setNewUser('');
          } catch (err) {
            alert('Error adding user: ' + err.message);
          }
        };

        const removeUser = async (user) => {
          try {
            await api.callPost('removeUser', { userName: user });
            setUsers(users.filter(u => u !== user));
          } catch (err) {
            alert('Error removing user: ' + err.message);
          }
        };

        const addDriver = async () => {
          if (!newDriver || activDrivers.includes(newDriver)) return;

          try {
            await api.callPost('addDriver', { driverName: newDriver });
            setActiveDrivers([...activDrivers, newDriver].sort());
            setNewDriver('');
          } catch (err) {
            alert('Error adding driver: ' + err.message);
          }
        };

        const removeDriver = async (driver) => {
          try {
            await api.callPost('removeDriver', { driverName: driver });
            setActiveDrivers(activDrivers.filter(d => d !== driver));
          } catch (err) {
            alert('Error removing driver: ' + err.message);
          }
        };

        const handleScheduleCSVUpload = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          setScheduleUploadStatus('Processing...');

          try {
            const newSchedule = await processCSV(file, ['name', 'date', 'track', 'type'], (lines, headers) => {
              const idIdx = headers.indexOf('id');
              const nameIdx = headers.indexOf('name');
              const dateIdx = headers.indexOf('date');
              const timeIdx = headers.indexOf('time');
              const trackIdx = headers.indexOf('track');
              const typeIdx = headers.indexOf('type');

              const schedule = [];
              for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim());
                schedule.push({
                  id: idIdx !== -1 && cols[idIdx] ? parseInt(cols[idIdx]) : i,
                  name: cols[nameIdx],
                  date: cols[dateIdx],
                  time: timeIdx !== -1 ? cols[timeIdx] : '',
                  track: cols[trackIdx],
                  type: cols[typeIdx]
                });
              }
              return schedule;
            });

            await api.callPost('saveRaces', { races: newSchedule });
            setRaces(newSchedule);
            setScheduleUploadStatus(`Success! Imported ${newSchedule.length} races`);
          } catch (err) {
            setScheduleUploadStatus(`Error: ${err.message}`);
          }
        };

        const handleCSVUpload = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          setUploadStatus('Processing...');

          try {
            const result = await processCSV(file, ['driver', 'points'], (lines, headers) => {
              const yearIdx = headers.indexOf('year');
              const raceIdx = headers.indexOf('race');
              const trackIdx = headers.indexOf('track');
              const trackTypeIdx = headers.indexOf('tracktype');
              const driverIdx = headers.indexOf('driver');
              const pointsIdx = headers.indexOf('points');
              const userIdx = headers.indexOf('user');

              const newHistoricalData = [];
              let imported = 0;
              let filtered = 0;

              for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim());
                const driver = cols[driverIdx];

                if (!activDrivers.includes(driver)) {
                  filtered++;
                  continue;
                }

                newHistoricalData.push({
                  year: yearIdx !== -1 ? cols[yearIdx] : '',
                  race: raceIdx !== -1 ? cols[raceIdx] : '',
                  track: trackIdx !== -1 ? cols[trackIdx] : '',
                  trackType: trackTypeIdx !== -1 ? cols[trackTypeIdx] : '',
                  driver: driver,
                  points: parseFloat(cols[pointsIdx]) || 0,
                  user: userIdx !== -1 ? cols[userIdx] : ''
                });
                imported++;
              }

              return { newHistoricalData, imported, filtered };
            });

            const updatedHistoricalData = [...historicalData, ...result.newHistoricalData];
            await api.callPost('saveHistoricalData', { historicalData: updatedHistoricalData });
            setHistoricalData(updatedHistoricalData);
            setUploadStatus(`Success! Imported ${result.imported} records, filtered out ${result.filtered} inactive drivers`);
          } catch (err) {
            setUploadStatus(`Error: ${err.message}`);
          }
        };

        return (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold">League Setup</h2>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">Import Race Schedule</h3>
              <p className="text-sm text-gray-600 mb-4">
                Upload a CSV file with the race schedule. Required columns: name, date, track, type. Optional: id, time
              </p>

              <div className="mb-4">
                <label className="block mb-2">
                  <span className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 cursor-pointer inline-flex items-center gap-2">
                    <Icons.Upload size={20} />
                    Choose Schedule CSV
                  </span>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleScheduleCSVUpload}
                    className="hidden"
                  />
                </label>
              </div>

              {scheduleUploadStatus && (
                <div className={`p-3 rounded ${getStatusClassName(scheduleUploadStatus)}`}>
                  {scheduleUploadStatus}
                </div>
              )}

              {races.length > 0 && (
                <div className="mt-4">
                  <p className="font-semibold">Current schedule: {races.length} races</p>
                </div>
              )}
            </div>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">Users</h3>
              <div className="flex gap-2 mb-4">
                <input
                  type="text"
                  value={newUser}
                  onChange={(e) => setNewUser(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && addUser()}
                  placeholder="Add user..."
                  className="flex-1 border rounded px-3 py-2"
                />
                <button onClick={addUser} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                  <Icons.Plus size={20} />
                </button>
              </div>
              <div className="flex flex-wrap gap-2">
                {users.map(user => (
                  <div key={user} className="flex items-center gap-2 bg-blue-100 px-3 py-1 rounded">
                    <span>{user}</span>
                    <button onClick={() => removeUser(user)} className="text-red-600 hover:text-red-800">
                      <Icons.X size={16} />
                    </button>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">Active Drivers</h3>
              <div className="flex gap-2 mb-4">
                <input
                  type="text"
                  value={newDriver}
                  onChange={(e) => setNewDriver(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && addDriver()}
                  placeholder="Add driver..."
                  className="flex-1 border rounded px-3 py-2"
                />
                <button onClick={addDriver} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                  <Icons.Plus size={20} />
                </button>
              </div>
              <div className="grid grid-cols-3 gap-2">
                {activDrivers.map(driver => (
                  <div key={driver} className="flex items-center gap-2 bg-green-100 px-3 py-1 rounded">
                    <span className="flex-1">{driver}</span>
                    <button onClick={() => removeDriver(driver)} className="text-red-600 hover:text-red-800">
                      <Icons.X size={16} />
                    </button>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-lg p-6 border">
              <h3 className="text-xl font-semibold mb-4">Import Historical Data</h3>
              <p className="text-sm text-gray-600 mb-4">
                Upload a CSV file with your historical race data. The file should include columns: year, race, track, tracktype, driver, points, user (optional).
                Only drivers in your active driver list will be imported.
              </p>

              <div className="mb-4">
                <label className="block mb-2">
                  <span className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer inline-flex items-center gap-2">
                    <Icons.Upload size={20} />
                    Choose CSV File
                  </span>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleCSVUpload}
                    className="hidden"
                  />
                </label>
              </div>

              {uploadStatus && (
                <div className={`p-3 rounded ${getStatusClassName(uploadStatus)}`}>
                  {uploadStatus}
                </div>
              )}

              {historicalData.length > 0 && (
                <div className="mt-4">
                  <p className="font-semibold">Total historical records: {historicalData.length}</p>
                  <button
                    onClick={async () => {
                      if (confirm('Are you sure you want to clear all historical data?')) {
                        await api.callPost('saveHistoricalData', { historicalData: [] });
                        setHistoricalData([]);
                        setUploadStatus('Historical data cleared');
                      }
                    }}
                    className="mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                  >
                    Clear Historical Data
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gray-100">
          <div className="bg-blue-700 text-white p-4 shadow-lg">
            <div className="flex justify-between items-center">
              <h1 className="text-3xl font-bold">NASCAR Fantasy League</h1>
              <div className="flex items-center gap-2">
                <span className={`text-sm px-2 py-1 rounded ${connectionStatus === 'connected' ? 'bg-green-500' :
                    connectionStatus === 'loading' ? 'bg-yellow-500' :
                      'bg-red-500'
                  }`}>
                  {connectionStatus === 'connected' ? '● Online' :
                    connectionStatus === 'loading' ? '● Loading...' :
                      '● Error'}
                </span>
              </div>
            </div>
          </div>

          <div className="flex">
            <nav className="w-64 bg-white shadow-lg min-h-screen p-4">
              <div className="space-y-2">
                <button onClick={() => setActiveTab('schedule')} className={`w-full flex items-center gap-3 px-4 py-3 rounded ${activeTab === 'schedule' ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}>
                  <Icons.Calendar size={20} /> Schedule
                </button>
                <button onClick={() => setActiveTab('leaderboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded ${activeTab === 'leaderboard' ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}>
                  <Icons.Trophy size={20} /> Leaderboard
                </button>
                <button onClick={() => setActiveTab('insights')} className={`w-full flex items-center gap-3 px-4 py-3 rounded ${activeTab === 'insights' ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}>
                  <Icons.TrendingUp size={20} /> Insights
                </button>
                <button onClick={() => setActiveTab('setup')} className={`w-full flex items-center gap-3 px-4 py-3 rounded ${activeTab === 'setup' ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}>
                  <Icons.Users size={20} /> Setup
                </button>
              </div>
            </nav>

            <main className="flex-1 p-8">
              {activeTab === 'schedule' && <SchedulePage />}
              {activeTab === 'race-detail' && <RaceDetailPage />}
              {activeTab === 'leaderboard' && <LeaderboardPage />}
              {activeTab === 'insights' && <InsightsPage />}
              {activeTab === 'setup' && <SetupPage />}
            </main>
          </div>
        </div>
      );
    };

    ReactDOM.render(<NASCARFantasyApp />, document.getElementById('root'));
  </script>
</body>

</html>
